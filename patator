#!/bin/bash

# ============================================================================
# üöÄ PATATOR - Script de D√©marrage Complet
# ============================================================================
# Projet : KiVendTout E-commerce Fraud Detection
# Auteur : Pierre Chevalier
# Date : F√©vrier 2026
# ============================================================================

set -e  # Exit on error

# Couleurs pour l'affichage
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
PURPLE='\033[0;35m'
CYAN='\033[0;36m'
NC='\033[0m' # No Color

# Emoji
ROCKET="üöÄ"
CHECK="‚úÖ"
CROSS="‚ùå"
HOURGLASS="‚è≥"
INFO="‚ÑπÔ∏è"
WARNING="‚ö†Ô∏è"

# Configuration
PROJECT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
LOG_DIR="$PROJECT_DIR/logs"
API_PORT=8000
DASHBOARD_PORT=7600

# ============================================================================
# Fonctions Utilitaires
# ============================================================================

print_header() {
    echo ""
    echo -e "${PURPLE}============================================================================${NC}"
    echo -e "${PURPLE}$1${NC}"
    echo -e "${PURPLE}============================================================================${NC}"
    echo ""
}

print_step() {
    echo -e "${CYAN}${HOURGLASS} $1...${NC}"
}

print_success() {
    echo -e "${GREEN}${CHECK} $1${NC}"
}

print_error() {
    echo -e "${RED}${CROSS} $1${NC}"
}

print_warning() {
    echo -e "${YELLOW}${WARNING} $1${NC}"
}

print_info() {
    echo -e "${BLUE}${INFO} $1${NC}"
}

check_command() {
    if command -v $1 &> /dev/null; then
        print_success "$1 est install√©"
        return 0
    else
        print_error "$1 n'est pas install√©"
        return 1
    fi
}

wait_for_service() {
    local url=$1
    local name=$2
    local max_attempts=30
    local attempt=1
    
    echo -n "   Attente de $name"
    while [ $attempt -le $max_attempts ]; do
        if curl -s "$url" > /dev/null 2>&1; then
            echo ""
            print_success "$name est op√©rationnel"
            return 0
        fi
        echo -n "."
        sleep 1
        ((attempt++))
    done
    echo ""
    print_error "$name n'a pas d√©marr√© apr√®s ${max_attempts}s"
    return 1
}

check_port() {
    if lsof -Pi :$1 -sTCP:LISTEN -t >/dev/null 2>&1; then
        return 0
    else
        return 1
    fi
}

kill_port() {
    local port=$1
    if check_port $port; then
        print_warning "Port $port occup√©, lib√©ration en cours..."
        lsof -ti:$port | xargs kill -9 2>/dev/null || true
        sleep 2
    fi
}

# ============================================================================
# Fonctions Principales
# ============================================================================

show_banner() {
    clear
    echo -e "${PURPLE}"
    cat << "EOF"
    ____  ___  __________  ________________  ____
   / __ \/   |/_  __/   |/_  __/ ____/ __ \/ __ \
  / /_/ / /| | / / / /| | / / / / __/ /_/ / /_/ /
 / ____/ ___ |/ / / ___ |/ / / /_/ / _, _/ _, _/
/_/   /_/  |_/_/ /_/  |_/_/  \____/_/ |_/_/ |_|

    KiVendTout E-commerce Fraud Detection
    Projet M1 Data Engineering - EFREI
    
EOF
    echo -e "${NC}"
}

check_prerequisites() {
    print_header "1Ô∏è‚É£  V√âRIFICATION DES PR√â-REQUIS"
    
    local all_ok=true
    
    check_command "docker" || all_ok=false
    check_command "docker-compose" || check_command "docker" || all_ok=false
    check_command "python3" || all_ok=false
    check_command "curl" || all_ok=false
    
    if [ "$all_ok" = false ]; then
        print_error "Certains pr√©-requis sont manquants"
        exit 1
    fi
    
    print_success "Tous les pr√©-requis sont satisfaits"
}

start_docker_services() {
    print_header "2Ô∏è‚É£  D√âMARRAGE DE L'INFRASTRUCTURE DOCKER"
    
    print_step "D√©marrage des 13 services Docker"
    cd "$PROJECT_DIR"
    
    if docker compose ps | grep -q "Up"; then
        print_info "Certains services sont d√©j√† actifs"
        docker compose up -d
    else
        docker compose up -d
    fi
    
    print_success "Services Docker d√©marr√©s"
    
    # Attendre que les services critiques soient pr√™ts
    print_step "Attente des services critiques..."
    
    # V√©rifier PostgreSQL
    local pg_attempts=0
    while [ $pg_attempts -lt 30 ]; do
        if docker compose exec -T postgres pg_isready -U postgres >/dev/null 2>&1; then
            print_success "PostgreSQL est pr√™t"
            break
        fi
        sleep 1
        ((pg_attempts++))
    done
    
    # V√©rifier Kafka
    local kafka_attempts=0
    while [ $kafka_attempts -lt 30 ]; do
        if docker compose exec -T kafka-1 kafka-broker-api-versions --bootstrap-server localhost:9092 >/dev/null 2>&1; then
            print_success "Kafka est pr√™t"
            break
        fi
        sleep 1
        ((kafka_attempts++))
    done
    
    print_success "Infrastructure Docker op√©rationnelle"
}

check_data_loaded() {
    print_step "V√©rification des donn√©es dans PostgreSQL"
    
    local count=$(docker compose exec -T postgres psql -U postgres -d kivendtout -c "SELECT COUNT(*) FROM customers;" 2>/dev/null | grep -o '[0-9]*' | head -1)
    
    if [ ! -z "$count" ] && [ "$count" -gt 0 ]; then
        print_success "Donn√©es PostgreSQL pr√©sentes ($count clients)"
        return 0
    else
        print_warning "Donn√©es PostgreSQL absentes ou incompl√®tes"
        return 1
    fi
}

load_initial_data() {
    print_header "3Ô∏è‚É£  CHARGEMENT DES DONN√âES"
    
    if check_data_loaded; then
        print_info "Donn√©es d√©j√† charg√©es, skip"
        return 0
    fi
    
    print_step "Chargement PostgreSQL"
    python3 "$PROJECT_DIR/scripts/load_data_to_postgres.py"
    print_success "PostgreSQL charg√©"
    
    print_step "Chargement MongoDB"
    python3 "$PROJECT_DIR/scripts/load_events_to_mongodb.py"
    print_success "MongoDB charg√©"
}

setup_kafka() {
    print_header "4Ô∏è‚É£  CONFIGURATION KAFKA"
    
    # V√©rifier si les topics existent
    if docker compose exec -T kafka-1 kafka-topics --bootstrap-server localhost:9092 --list 2>/dev/null | grep -q "payments"; then
        print_info "Topics Kafka d√©j√† cr√©√©s"
    else
        print_step "Cr√©ation des topics Kafka"
        python3 "$PROJECT_DIR/scripts/create_kafka_topics.py" || true
        print_success "Topics Kafka cr√©√©s"
    fi
    
    # V√©rifier si les √©v√©nements sont stream√©s
    local msg_count=$(docker compose exec -T kafka-1 kafka-run-class kafka.tools.GetOffsetShell --broker-list localhost:9092 --topic payments 2>/dev/null | tail -1 | cut -d':' -f3 || echo "0")
    
    if [ "$msg_count" -gt 1000 ]; then
        print_info "√âv√©nements d√©j√† stream√©s dans Kafka ($msg_count messages)"
    else
        print_step "Streaming des √©v√©nements vers Kafka"
        python3 "$PROJECT_DIR/scripts/stream_events_to_kafka.py"
        print_success "71,694 √©v√©nements stream√©s"
    fi
}

start_fraud_detection() {
    print_header "5Ô∏è‚É£  D√âTECTION DE FRAUDE"
    
    # V√©rifier si des alertes existent d√©j√†
    local alert_count=$(docker compose exec -T postgres psql -U postgres -d kivendtout -c "SELECT COUNT(*) FROM fraud_alerts;" 2>/dev/null | grep -o '[0-9]*' | head -1 || echo "0")
    
    if [ "$alert_count" -gt 100 ]; then
        print_info "Alertes de fraude d√©j√† g√©n√©r√©es ($alert_count alertes)"
    else
        print_step "Lancement de la d√©tection de fraude"
        python3 "$PROJECT_DIR/scripts/fraud_detection_realtime.py" > "$LOG_DIR/fraud_detection.log" 2>&1 &
        local pid=$!
        
        # Attendre max 60 secondes
        sleep 60
        
        if ps -p $pid > /dev/null; then
            kill $pid 2>/dev/null || true
        fi
        
        print_success "D√©tection de fraude termin√©e"
    fi
}

start_api() {
    print_header "6Ô∏è‚É£  D√âMARRAGE DE L'API BACKEND"
    
    # V√©rifier si l'API tourne d√©j√†
    if check_port $API_PORT; then
        print_info "API d√©j√† active sur le port $API_PORT"
        return 0
    fi
    
    print_step "D√©marrage de l'API FastAPI"
    python3 "$PROJECT_DIR/api/fraud_dashboard_api.py" > "$LOG_DIR/fraud_dashboard_api.log" 2>&1 &
    
    wait_for_service "http://localhost:$API_PORT/health" "API Backend"
    
    # Sync alertes depuis Kafka
    print_step "Synchronisation des alertes depuis Kafka"
    sleep 3
    curl -X POST "http://localhost:$API_PORT/api/sync" > /dev/null 2>&1 || true
    print_success "Alertes synchronis√©es"
}

start_dashboard() {
    print_header "7Ô∏è‚É£  D√âMARRAGE DU DASHBOARD WEB"
    
    # V√©rifier si le dashboard tourne d√©j√†
    if check_port $DASHBOARD_PORT; then
        print_info "Dashboard d√©j√† actif sur le port $DASHBOARD_PORT"
        return 0
    fi
    
    print_step "D√©marrage du serveur HTTP pour le dashboard"
    cd "$PROJECT_DIR/dashboard"
    python3 -m http.server $DASHBOARD_PORT > "$LOG_DIR/http_server.log" 2>&1 &
    
    sleep 2
    wait_for_service "http://localhost:$DASHBOARD_PORT/fraud_dashboard.html" "Dashboard Web"
}

show_summary() {
    print_header "8Ô∏è‚É£  R√âCAPITULATIF ET ACC√àS"
    
    # R√©cup√©rer les stats
    local stats=$(curl -s "http://localhost:$API_PORT/api/stats" 2>/dev/null || echo "{}")
    local total_alerts=$(echo "$stats" | python3 -c "import sys, json; data=json.load(sys.stdin); print(data.get('total_alerts', 'N/A'))" 2>/dev/null || echo "N/A")
    local fraud_rate=$(echo "$stats" | python3 -c "import sys, json; data=json.load(sys.stdin); print(f\"{data.get('fraud_rate', 0):.2f}%\")" 2>/dev/null || echo "N/A")
    
    echo -e "${GREEN}"
    cat << EOF
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ                    üéâ PATATOR EST OP√âRATIONNEL !                ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò

üìä STATISTIQUES:
   ‚Ä¢ Total alertes de fraude : $total_alerts
   ‚Ä¢ Taux de fraude          : $fraud_rate

üåê SERVICES DISPONIBLES:

   üñ•Ô∏è  DASHBOARD WEB (Interface Analyst)
   ‚Üí http://localhost:$DASHBOARD_PORT/fraud_dashboard.html
   
   üîå API REST (Backend)
   ‚Üí http://localhost:$API_PORT
   ‚Üí http://localhost:$API_PORT/health
   
   üìä KAFKA UI (Monitoring Kafka)
   ‚Üí http://localhost:8082
   
   üêò FLINK WEB UI (Processing)
   ‚Üí http://localhost:8083
   
   üìà GRAFANA (Dashboards)
   ‚Üí http://localhost:4000
   
   üî• PROMETHEUS (Metrics)
   ‚Üí http://localhost:9090

üê≥ SERVICES DOCKER (13):
EOF
    docker compose ps | grep -E "(Up|running)" | awk '{print "   ‚úÖ " $1}'
    
    echo ""
    echo -e "${CYAN}üìù LOGS:${NC}"
    echo "   ‚Ä¢ API Backend     : tail -f $LOG_DIR/fraud_dashboard_api.log"
    echo "   ‚Ä¢ Fraud Detection : tail -f $LOG_DIR/fraud_detection.log"
    echo "   ‚Ä¢ HTTP Server     : tail -f $LOG_DIR/http_server.log"
    
    echo ""
    echo -e "${YELLOW}üõë POUR TOUT ARR√äTER:${NC}"
    echo "   cd $PROJECT_DIR && docker compose down"
    
    echo -e "${GREEN}"
    echo "‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê"
    echo "‚îÇ           Bon courage avec votre projet ! üöÄ                    ‚îÇ"
    echo "‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò"
    echo -e "${NC}"
}

open_dashboard() {
    print_info "Ouverture automatique du dashboard dans 5 secondes..."
    sleep 5
    
    if command -v open &> /dev/null; then
        # macOS
        open "http://localhost:$DASHBOARD_PORT/fraud_dashboard.html"
    elif command -v xdg-open &> /dev/null; then
        # Linux
        xdg-open "http://localhost:$DASHBOARD_PORT/fraud_dashboard.html"
    elif command -v start &> /dev/null; then
        # Windows
        start "http://localhost:$DASHBOARD_PORT/fraud_dashboard.html"
    fi
}

# ============================================================================
# Fonction Principale
# ============================================================================

main() {
    show_banner
    
    # Cr√©er le dossier logs si n√©cessaire
    mkdir -p "$LOG_DIR"
    
    # Ex√©cution s√©quentielle
    check_prerequisites
    start_docker_services
    load_initial_data
    setup_kafka
    start_fraud_detection
    start_api
    start_dashboard
    show_summary
    
    # Ouvrir le dashboard
    open_dashboard
}

# ============================================================================
# Point d'entr√©e
# ============================================================================

# Trap CTRL+C
trap 'echo -e "\n${RED}‚ùå Interruption par l'\''utilisateur${NC}"; exit 1' INT

# Lancer le script
main "$@"
